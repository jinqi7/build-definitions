apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: snyk-code-test
spec:
  description: >-
    Static code security test with snyk
  results:
    - description: Test output
      name: HACBS_TEST_OUTPUT
  params:
    - name: SHARED_SECRET
      default: test-team-snyk
    - name: ARGS
      type: string
      description: extra args needs to append
      default: "--all-projects --exclude=test*,vendor,deps"
  volumes:
    - name: snyk-secret
      csi:
        readOnly: true
        driver: csi.sharedresource.openshift.io
        volumeAttributes:
          sharedSecret: $(params.SHARED_SECRET)
  steps:
    - name: snyk-code-test
      image: quay.io/redhat-appstudio/hacbs-test:feature-sast
      workingDir: $(workspaces.workspace.path)
      volumeMounts:
        - name: snyk-secret
          mountPath: "/etc/secrets"
          readOnly: true
      script: |
        #!/usr/bin/env bash
        SNYK_TOKEN="$(cat /etc/secrets/snyk_token)"
        if [[ -z $SNYK_TOKEN ]]; then
          echo "SNYK_TOKEN is empty and a secret 'test-team-snyk' which includes 'snyk_token' need to be created in test-team namespace"
          exit 0
        fi
        export SNYK_TOKEN
        SNYK_EXIT_CODE=0
        tmp_dir="hacbs/$(context.task.name)"
        mkdir -p $tmp_dir
        snyk code test $(params.ARGS) --sarif-file-output=$tmp_dir/snyk_code_test_out.json 1>&2> $tmp_dir/stdout.out || SNYK_EXIT_CODE=$?
        if [[ "$SNYK_EXIT_CODE" -eq 0 ]] || [[ "$SNYK_EXIT_CODE" -eq 1 ]]; then
          HACBS_TEST_OUTPUT=$(jq -rce --arg date $(date +%s) \
            '{ result: (if (.runs[].results | length > 0) then "FAILURE" else "SUCCESS" end),
                   timestamp: $date,
                   namespace: "default",
                   successes: 0,
                   failures: (.runs[].results // [])|map(.message.text)
                 }' $tmp_dir/snyk_code_test_out.json || true)
        else
          ERR_MSG="$(cat test/stdout.out)"
          HACBS_ERROR_OUTPUT=$(jq -rc --arg date $(date +%s) --arg ERR_MESSAGE "${ERR_MSG}" --null-input \
            '{result: "ERROR", timestamp: $date, failures: [$ERR_MESSAGE]}')
        fi
        echo "${HACBS_TEST_OUTPUT:-${HACBS_ERROR_OUTPUT}}" | tee $(results.HACBS_TEST_OUTPUT.path)
  workspaces:
  - name: workspace
